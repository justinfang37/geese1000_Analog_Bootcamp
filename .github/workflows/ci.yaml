name: CI
on:
  push:
    paths:
      - 'caravel/**'
      - '.github/workflows/**'
  workflow_dispatch:
jobs:
  detect_project_type:
    runs-on: ubuntu-24.04
    outputs:
      has_analog: ${{ steps.check.outputs.has_analog }}
      has_digital: ${{ steps.check.outputs.has_digital }}
      project_type: ${{ steps.check.outputs.project_type }}
      has_caravel: ${{ steps.check.outputs.has_caravel }}
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
      
      - name: Check for caravel directory and detect project structure
        id: check
        run: |
          # Detect project structure using same logic as flows/Makefile
          # STATE_KEY is HAS_ANALOG+HAS_DIGITAL+HAS_CARAVEL (e.g., "010" = digital only)
          
          HAS_ANALOG="0"
          HAS_DIGITAL="0"
          HAS_CARAVEL="0"
          
          if [ -d "analog" ]; then
            HAS_ANALOG="1"
          fi
          
          if [ -d "digital" ]; then
            HAS_DIGITAL="1"
          fi
          
          if [ -d "caravel" ]; then
            HAS_CARAVEL="1"
          fi
          
          STATE_KEY="${HAS_ANALOG}${HAS_DIGITAL}${HAS_CARAVEL}"
          
          # Determine project type based on STATE_KEY (matching flows/Makefile logic)
          case "${STATE_KEY}" in
            "000") PROJECT_TYPE="none" ;;
            "111") PROJECT_TYPE="mixed" ;;
            "010"|"011") PROJECT_TYPE="digital" ;;
            "100"|"101") PROJECT_TYPE="analog" ;;
            "001") PROJECT_TYPE="caravel" ;;
            *) PROJECT_TYPE="unknown" ;;
          esac
          
          echo "has_analog=$( [ \"${HAS_ANALOG}\" = \"1\" ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "has_digital=$( [ \"${HAS_DIGITAL}\" = \"1\" ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "has_caravel=$( [ \"${HAS_CARAVEL}\" = \"1\" ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "project_type=${PROJECT_TYPE}" >> $GITHUB_OUTPUT
          

          
          echo "Detected project type: ${PROJECT_TYPE}"

  # Run docs for any valid project type (analog, digital, mixed, caravel)
  docs:
    needs: detect_project_type
    if: |
      needs.detect_project_type.outputs.project_type == 'analog' ||
      needs.detect_project_type.outputs.project_type == 'digital' ||
      needs.detect_project_type.outputs.project_type == 'mixed' ||
      needs.detect_project_type.outputs.project_type == 'caravel'
    uses: ./.github/workflows/docs.yaml

  # Run GDS for any valid project type (handles mixed projects internally)
  gds:
    needs: detect_project_type
    if: |
      needs.detect_project_type.outputs.project_type == 'analog' ||
      needs.detect_project_type.outputs.project_type == 'digital' ||
      needs.detect_project_type.outputs.project_type == 'mixed' ||
      needs.detect_project_type.outputs.project_type == 'caravel'
    uses: ./.github/workflows/gds.yaml
    with:
      project_type: ${{ needs.detect_project_type.outputs.project_type }}

  # Only run for digital or mixed projects (has digital module)
  fpga:
    needs: detect_project_type
    if: needs.detect_project_type.outputs.project_type == 'digital' || needs.detect_project_type.outputs.project_type == 'mixed'
    uses: ./.github/workflows/fpga.yaml

  # Only run for digital or mixed projects (has digital module)
  test:
    needs: detect_project_type
    if: needs.detect_project_type.outputs.project_type == 'digital' || needs.detect_project_type.outputs.project_type == 'mixed'
    uses: ./.github/workflows/test.yaml
